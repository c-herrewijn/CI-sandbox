name: Afl++ Fuzzer
on: workflow_dispatch

jobs:
  # https://github.com/AFLplusplus/AFLplusplus/blob/stable/docs/INSTALL.md
  install-aflplusplus:
    name: Install AFL++
    runs-on: ubuntu-24.04

    steps:
      - name: install dependencies
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-dev automake cmake git flex bison libglib2.0-dev libpixman-1-dev python3-setuptools cargo libgtk-3-dev
          sudo apt-get install -y lld-14 llvm-14 llvm-14-dev clang-14 || sudo apt-get install -y lld llvm llvm-dev clang
          sudo apt-get install -y gcc-$(gcc --version|head -n1|sed 's/\..*//'|sed 's/.* //')-plugin-dev libstdc++-$(gcc --version|head -n1|sed 's/\..*//'|sed 's/.* //')-dev

      - name: Checkout duckdb_aflplusplus
        uses: actions/checkout@v4
        with:
          path: duckdb_aflplusplus

      - name: Checkout aflplusplus
        uses: actions/checkout@v4
        with:
          repository: aflplusplus/aflplusplus
          path: aflplusplus
          ref: stable

      - name: Checkout duckdb
        uses: actions/checkout@v4
        with:
          repository: duckdb/duckdb
          path: duckdb

      - name: Setup Ccache
        uses: hendrikmuhs/ccache-action@main
        with:
          key: ${{ github.job }}
          create-symlink: true

      - name: build AFL++
        shell: bash
        run: |
          cd aflplusplus
          pwd
          echo ${{ github.workspace }}
          ls /
          env
          sudo make source-only
          sudo make install

      - name: build DuckDB
        shell: bash
        run: |
          cd duckdb
          pwd
          sudo make CC=${{ github.workspace }}/aflplusplus/afl-clang-fast CXX=${{ github.workspace }}/aflplusplus/afl-clang-fast++ BUILD_JEMALLOC=1 duckdb-lib

      - name: AFL++ version
        run: "afl-fuzz --version"
